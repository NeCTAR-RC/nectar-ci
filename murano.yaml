- project:
    name: murano-rstudio
    jobs:
      - 'murano-package-check-{name}'
      - 'murano-package-deploy-{name}'

- project:
    name: murano-jupyternotebook
    jobs:
      - 'murano-package-check-{name}'
      - 'murano-package-deploy-{name}'

- project:
    name: murano-glamworkbench
    jobs:
      - 'murano-package-check-{name}'
      - 'murano-package-deploy-{name}'


- job-template:
    name: 'murano-package-check-{name}'
    defaults: global
    node: focal

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'NeCTAR-RC/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - shell: make check

    wrappers:
      - credentials-binding:
        - username-password-separated:
           credential-id: 96a5a52d-2ad9-4f6f-a9fa-76bd2d057416
           username: CREDENTIAL_ID
           password: CREDENTIAL_SECRET
        - username-password:
           credential-id: 2f00f9a5-00c3-42fe-82bf-cc787af1df8c
           variable: GERRIT_API


- job-template:
    name: 'murano-package-deploy-{name}'
    defaults: global
    node: openstack
    project-type: pipeline
    sandbox: true

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'NeCTAR-RC/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

    dsl: |
        pipeline {{
            agent {{ label 'focal' }}
            options {{
                preserveStashes(buildCount: 1)
                ansiColor('xterm')
            }}
            stages {{
                stage('Clone') {{
                    steps {{
                        git poll: false,
                        url: 'ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/{name}.git',
                        credentialsId: '4946c3a5-9f5e-4eac-9ec4-90e1e348db14',
                        branch: '$GERRIT_BRANCH'
                    }}
                }}
                stage('Build package in RCTest') {{
                    steps {{
                        buildMuranoPackage 'murano', 'testing'
                    }}
                }}
                stage('Deploy package in RCTest') {{
                    steps {{
                        deployMuranoPackage 'murano', 'testing'
                    }}
                }}
                stage('Build package in Production') {{
                    steps {{
                        buildMuranoPackage 'murano', 'production'
                    }}
                }}
                stage('Deploy package in Production') {{
                    steps {{
                        deployMuranoPackage 'murano', 'production'
                    }}
                }}
            }}
            post {{
                cleanup {{
                    deleteDir()
                }}
            }}
        }}
