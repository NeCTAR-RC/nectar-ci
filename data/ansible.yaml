- project:
    name: beeswax
    jobs:
      - '{name}-pre-commit-all':
          organisation: 'internal'
- project:
    name: nectar-ops
    jobs:
      - '{name}-pre-commit-all':
          organisation: 'internal'
- project:
    name: nectar-ansible
    jobs:
      - '{name}-pre-commit-all':
          organisation: 'internal'
- job:
    name: 'nectar-ansible-check'
    concurrent: false
    defaults: global
    node: internal
    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."
    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
            - comment-added-contains-event:
                comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'internal/nectar-ansible'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true
    scm:
      - git:
          url: ssh://jenkins@review.rc.nectar.org.au:29418/internal/nectar-ansible.git
          credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
          refspec: $GERRIT_REFSPEC
          branches:
            - origin/$GERRIT_BRANCH
          skip-tag: true
          wipe-workspace: false
          clean:
            after: true
          choosing-strategy: gerrit
    wrappers:
      - ansicolor
      - ssh-agent-credentials:
          users:
            - cd8b8dd3-b897-4ecb-985d-180d5b6f8498
      - credentials-binding:
          - username-password-separated:
              credential-id: 84081149-2b09-4038-93a6-ea964e8ceba8
              username: AWS_ACCESS_KEY_ID
              password: AWS_SECRET_ACCESS_KEY
    builders:
      - shell: |
          export OS_TEST_TIMEOUT=300
          export ANSIBLE_FORCE_COLOR=true
          tox -e {task} -- playbook-*.yaml
- job:
    name: 'nectar-ansible-deploy'
    concurrent: false
    defaults: global
    node: internal
    parameters:
      - choice:
          name: 'PLAYBOOK'
          choices:
            - s3
          description: "Playbook to deploy"
    scm:
      - git:
          url: ssh://jenkins@review.rc.nectar.org.au:29418/internal/nectar-ansible.git
          credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
    wrappers:
      - ansicolor
      - ssh-agent-credentials:
          users:
            - cd8b8dd3-b897-4ecb-985d-180d5b6f8498
      - credentials-binding:
          - username-password-separated:
              credential-id: 84081149-2b09-4038-93a6-ea964e8ceba8
              username: AWS_ACCESS_KEY_ID
              password: AWS_SECRET_ACCESS_KEY
    builders:
      - shell: |
          export ANSIBLE_FORCE_COLOR=true
          tox -e deploy -- playbook-${PLAYBOOK}.yaml
