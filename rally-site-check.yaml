- project:
    name: site-check
    deployment: monitoring
    site:
        - intersect-01:
            availability-zone: intersect-01
        - intersect-02:
            availability-zone: intersect-02
        - melbourne-np:
            availability-zone: melbourne-np
        - melbourne-qh2:
            availability-zone: melbourne-qh2
        - monash-01:
            availability-zone: monash-01
        - monash-02:
            availability-zone: monash-02
        - nci:
            availability-zone: NCI
        - pawsey:
            availability-zone: pawsey
        - qld:
            availability-zone: QRIScloud
        - sa:
            availability-zone: sa
        - tasmania:
            availability-zone: tasmania
    jobs:
      - 'rally-{name}-{site}'

- job-template:
    name: 'rally-{name}-{site}'
    project-type: freestyle
    defaults: global
    node: rally
    concurrent: false

    parameters:
      - string:
          name: 'IMAGE_ID'
          default: 'eeedf697-5a41-4d91-a478-01bb21e32cbe'
          description: 'The ID of the glance image to test with.'
      - string:
          name: 'FLAVOR_NAME'
          default: 'm2.tiny'
          description: 'The name of the flavor to test with.'

    triggers:
      - timed: 'H */6 * * *'

    properties:
      - authorization:
          'anonymous':
            - job-read
            - job-discover

    scm:
      - git:
         url: https://github.com/NeCTAR-RC/rally-jobs.git
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true

    builders:
      - shell: |
          #!/bin/bash -xe
          cd monitoring
          rally deployment use {deployment}
          rally task start site-check.yaml --task-args "{{\"availability_zone\":\"{availability-zone}\", \"image_id\":\"$IMAGE_ID\", \"flavor_name\":\"$FLAVOR_NAME\"}}" --tag "$BUILD_TAG"
          TASK=$(rally task list | awk "/$BUILD_TAG/ {{print \$2}}")
          cd ..
          rally task report --tasks $TASK --html --out output.html
          rally task report --tasks $TASK --junit --out output.xml
          rally task sla_check --uuid $TASK
          RET=$?
          rally task delete --uuid $TASK
          exit $RET

    publishers:
      - html-publisher:
          name: "Rally Report"
          dir: "."
          files: "output.html"
          keep-all: true
          allow-missing: true
      - junit:
          results: output.xml
      - slack:
          team-domain: 'researchcloud'
          auth-token: 'x8QkGgv2L4rl6pjN9DFeeaUo'
          room: '#dev'
          notify-start: true
          notify-success: true
          notify-aborted: true
          notify-notbuilt: true
          notify-unstable: true
          notify-failure: true
          notify-backtonormal: true
          notify-repeatedfailure: true


- project:
    name: flavor-check
    deployment: monitoring
    flavor:
        - 'm2.xsmall':
            avg_time: 150
            max_time: 300
            run_freq: 2
        - 'm2.small':
            avg_time: 150
            max_time: 300
            run_freq: 2
        - 'm2.medium':
            avg_time: 150
            max_time: 300
            run_freq: 2
        - 'm2.large':
            avg_time: 350
            max_time: 600
            run_freq: 2
        - 'm2.xlarge':
            avg_time: 1500
            max_time: 2000
            run_freq: 6
    jobs:
      - 'rally-{name}-{flavor}'

- job-template:
    name: 'rally-{name}-{flavor}'
    project-type: freestyle
    defaults: global
    node: rally
    concurrent: false

    parameters:
      - string:
          name: 'IMAGE_ID'
          default: 'eeedf697-5a41-4d91-a478-01bb21e32cbe'
          description: 'The ID of the glance image to test with.'

    triggers:
      - timed: 'H */{run_freq} * * *'

    properties:
      - authorization:
          'anonymous':
            - job-read
            - job-discover

    scm:
      - git:
         url: https://github.com/NeCTAR-RC/rally-jobs.git
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true

    builders:
      - shell: |
          #!/bin/bash -xe
          cd monitoring
          rally deployment use {deployment}
          rally task start flavor-check.yaml --task-args "{{\"image_id\":\"$IMAGE_ID\", \"flavor_name\":\"{flavor}\", \"max_avg_duration\":{avg_time}, \"max_seconds_per_iteration\":{max_time}}}" --tag "$BUILD_TAG"
          TASK=$(rally task list | awk "/$BUILD_TAG/ {{print \$2}}")
          cd ..
          rally task report --tasks $TASK --html --out output.html
          rally task report --tasks $TASK --junit --out output.xml
          rally task sla_check --uuid $TASK
          RET=$?
          rally task delete --uuid $TASK
          exit $RET

    publishers:
      - html-publisher:
          name: "Rally Report"
          dir: "."
          files: "output.html"
          keep-all: true
          allow-missing: true
      - junit:
          results: output.xml
      - slack:
          team-domain: 'researchcloud'
          auth-token: 'x8QkGgv2L4rl6pjN9DFeeaUo'
          room: '#dev'
          notify-start: true
          notify-success: true
          notify-aborted: true
          notify-notbuilt: true
          notify-unstable: true
          notify-failure: true
          notify-backtonormal: true
          notify-repeatedfailure: true

