- project:
    name: lab-kubernetes
    jobs:
      - '{name}-dummy':
         access: 'nobody'
         organisation: 'NeCTAR-RC'

- project:
    name: nectar-images
    jobs:
      - '{name}-dummy':
         access: 'nobody'
         organisation: 'NeCTAR-RC'

- project:
    name: gitea-theme-ardc
    jobs:
      - '{name}-dummy':
         access: 'nobody'
         organisation: 'NeCTAR-RC'

- job:
    name: 'librarian-verify'
    concurrent: false
    defaults: global

    node: upgrader

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          'nobody':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'internal/puppet-library'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/internal/puppet-library.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - shell: |
          export http_proxy=http://wwwproxy.unimelb.edu.au:8000
          export https_proxy=http://wwwproxy.unimelb.edu.au:8000
          cd testing
          librarian-puppet install --verbose --path ~/puppet-modules-cache/


- job:
    name: 'librarian-install'
    defaults: global
    node: upgrader
    quiet-period: 20

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'internal/puppet-library'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/internal/puppet-library.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - librarian-install

    publishers:
      !include: publisher.yaml.inc


- job:
    name: 'global-hieradata-deploy'
    defaults: global
    node: upgrader
    quiet-period: 20

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'internal/hieradata'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/internal/hieradata.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - ssh-builder:
          ssh-user-ip: puppet@puppet.mgmt.rc.nectar.org.au:22
          command: /usr/local/sbin/deploy-internal-hieradata.sh

    publishers:
      !include: publisher.yaml.inc


- project:
    name: nectar-testing
    jobs:
      - '{name}-yaml':
         access: 'nobody'
         organisation: 'internal'
      - '{name}-bionic-tox-{environment}':
         access: 'nobody'
         environment: 'pep8'
         organisation: 'internal'


- project:
    name: nectar-reports
    jobs:
      - '{name}-xenial-tox-{environment}':
         access: 'nobody'
         environment: 'pep8'
         organisation: 'internal'


- project:
    name: murano-docker-apps
    jobs:
      - '{name}-xenial-tox-{environment}':
         access: 'nobody'
         environment: 'yamllint'
         organisation: 'NeCTAR-RC'
      - '{name}-xenial-tox-{environment}':
         access: 'nobody'
         environment: 'shellcheck'
         organisation: 'NeCTAR-RC'
      - '{name}-xenial-tox-{environment}':
         access: 'nobody'
         environment: 'murano-pkg-check'
         organisation: 'NeCTAR-RC'


- project:
    name: spartan-resplat
    jobs:
      - '{name}-dummy':
         access: 'nobody'
         organisation: 'resplat-hpc'

- project:
    name: spartan-slurmconf
    jobs:
      - '{name}-dummy':
         access: 'nobody'
         organisation: 'resplat-hpc'

- project:
    name: midonet
    jobs:
      - '{name}-dummy':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
