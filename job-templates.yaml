- job-template:
    name: '{name}-git-secrets-sorted'
    defaults: global
    node: generic

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'main'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - git-secrets-sorted


- job-template:
    id: '{name}-puppet-unit-job'
    name: '{name}-puppet-unit{name-suffix}'
    name-suffix: ''
    defaults: global
    node: '{node}'

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'production'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'oldnova'
          silent: false
          escape-quotes: true
          skip-vote:
              successful: '{skip-vote}'
              failed: '{skip-vote}'
              unstable: '{skip-vote}'
              notbuilt: '{skip-vote}'

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - puppet-lint
      - puppet-syntax

    publishers:
      - warnings:
          console-log-parsers:
            - Puppet-Lint

    wrappers:
      - ansicolor


- job-template:
    name: '{name}-puppet-git-secrets'
    defaults: global
    node: generic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

    scm:
      - git:
          url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
          credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
          refspec: $GERRIT_REFSPEC
          branches:
            - origin/$GERRIT_BRANCH
          skip-tag: true
          wipe-workspace: false
          clean:
           after: true
          choosing-strategy: gerrit

    builders:
      - puppet-git-secrets

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'


- job-template:
    name: '{name}-puppet-openstack-spec'
    defaults: global
    node: focal
    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."
    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          skip-vote:
              successful: '{skip-vote}'
              failed: '{skip-vote}'
              unstable: '{skip-vote}'
              notbuilt: '{skip-vote}'
    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit
    builders:
      - puppet-openstack-spec
    wrappers:
      - ansicolor


- job-template:
    name: '{name}-helm-lint'
    defaults: global
    node: internal

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'production'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - helm-dependency-build
      - helm-template
      - helm-lint


- job-template:
    name: '{name}-helm-package'
    defaults: global
    node: internal
    concurrent: false

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'production'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    wrappers:
      - credentials-binding:
        - username-password-separated:
           credential-id: registry-nectar
           username: REGISTRY_USR
           password: REGISTRY_PSW

    builders:
      - helm-dependency-build
      - helm-package
      - helm-push


- job-template:
    name: '{name}-kustomize-validate'
    defaults: global
    node: internal

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'production'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - kustomize-validate

- job-template:
    name: '{name}-focal-deb-package'
    defaults: global
    node: jammy-zed

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'uom/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - pbuilder-create:
          os_release: "focal"
      - pbuilder-buildpackage:
          os_release: "focal"

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'
- job-template:
    name: '{name}-jammy-deb-package'
    defaults: global
    node: jammy-zed

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'uom/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - pbuilder-create:
          os_release: "jammy"
      - pbuilder-buildpackage:
          os_release: "jammy"

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'

- job-template:
    name: '{name}-bionic-deb-package'
    defaults: global
    node: jammy-zed

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'uom/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - pbuilder-create:
          os_release: "bionic"
      - pbuilder-buildpackage:
          os_release: "bionic"

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'


- job-template:
    name: '{name}-os-deb-package'
    defaults: global
    node: jammy-zed

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'uom/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - os-pbuilder-create
      - os-pbuilder-buildpackage

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'

- job-template:
    name: '{name}-yaml'
    defaults: global
    node: generic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

    scm:
      - git:
          url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
          credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
          refspec: $GERRIT_REFSPEC
          branches:
            - origin/$GERRIT_BRANCH
          skip-tag: true
          wipe-workspace: false
          clean:
           after: true
          choosing-strategy: gerrit

    builders:
      - yaml-lint

- job-template:
    name: '{name}-yamllint'
    defaults: global
    node: focal

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

    scm:
      - git:
          url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
          credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
          refspec: $GERRIT_REFSPEC
          branches:
            - origin/$GERRIT_BRANCH
          skip-tag: true
          wipe-workspace: false
          clean:
           after: true
          choosing-strategy: gerrit

    builders:
      - yamllint


- job-template:
    name: '{name}-dummy'
    defaults: global
    node: generic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'main'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - dummy

- job-template:
    name: '{name}-dummy-debian'
    defaults: global
    node: generic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - dummy

- job-template:
    name: '{name}-markdown'
    defaults: global
    node: generic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit


    builders:
      - markdown-lint


- job-template:
    name: '{name}-jekyll-test-build'
    defaults: global
    node: focal

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - jekyll-test-build

    wrappers:
      - credentials-binding:
        - username-password-separated:
           credential-id: 96a5a52d-2ad9-4f6f-a9fa-76bd2d057416
           username: CREDENTIAL_ID
           password: CREDENTIAL_SECRET
        - username-password:
           credential-id: 2f00f9a5-00c3-42fe-82bf-cc787af1df8c
           variable: GERRIT_API


- job-template:
    name: '{name}-jekyll-html-check'
    defaults: global
    node: bionic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - jekyll-html-check


- job-template:
    name: '{name}-jekyll-test-build-cleanup'
    defaults: global
    node: generic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
            - change-abandoned-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - jekyll-test-build-cleanup

    wrappers:
      - credentials-binding:
        - username-password-separated:
           credential-id: 96a5a52d-2ad9-4f6f-a9fa-76bd2d057416
           username: CREDENTIAL_ID
           password: CREDENTIAL_SECRET


- job-template:
    name: '{name}-puppet-prod-review'
    defaults: global
    node: generic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - puppet-prod-review

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'

- job-template:
    name: '{name}-site-deploy'
    defaults: global
    node: internal
    quiet-period: 15

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."
      - string:
          name: GERRIT_PROJECT
          default: '{organisation}/{name}'
          description: "The fully qualified project name."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - site-deploy

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'

- job-template:
    name: '{name}-r10k-deploy'
    defaults: global
    node: internal

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
            - change-restored-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - r10k-deploy:
          r10k_host: '{r10k_host}'

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'
      - credentials-binding:
        - text:
           credential-id: 2810b63c-d4ec-47df-b8f4-660e7902a358
           variable: TOKEN


- job-template:
    name: '{name}-r10k-deploy-control-repo'
    defaults: global
    node: internal
    quiet-period: 30

    properties:
      - build-blocker:
          blocking-jobs:
            - "{name}-r10k-cleanup"
          block-level: 'GLOBAL'

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."
      - string:
          name: GERRIT_PROJECT
          default: '{organisation}/{name}'
          description: "The fully qualified project name."

    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - r10k-deploy-control-repo:
          puppet_host: '{puppet_host}'

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'
      - credentials-binding:
        - text:
           credential-id: 2810b63c-d4ec-47df-b8f4-660e7902a358
           variable: TOKEN


- job-template:
    name: '{name}-r10k-cleanup'
    defaults: global
    node: internal

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."
      - string:
          name: GERRIT_PROJECT
          default: '{organisation}/{name}'
          description: "The fully qualified project name."

    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
            - change-abandoned-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - r10k-cleanup:
          r10k_host: '{r10k_host}'

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'


- job-template:
    name: tempest-{name}-check
    defaults: global
    node: tempest
    concurrent: true
    scm:
      - git:
         url: ssh://review.rc.nectar.org.au:29418/internal/nectar-testing.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
    builders:
      - tempest-check-whitelist:
          check: '{name}'
          whitelist: '{whitelist}'
    parameters:
      - choice:
          name: 'CLOUD'
          choices:
            - production
            - testing
            - development
          description: "Cloud to run tempest on (Production, Test, Dev). Leave as Production if unsure."
      - choice:
          name: 'AVAILABILITY_ZONE'
          choices:
            - ardc-mel-1
            - auckland
            - intersect-01
            - melbourne-qh2
            - melbourne-qh2-uom
            - monash-01
            - monash-02
            - monash-03
            - qld
            - swinburne-01
            - tasmania
            - tasmania-02
            - tasmania-s
            - coreservices
            - qh2-test
            - monash-test
            - aucklandtest
            - lani
            - luna
          description: 'Availability zone.'
    properties:
      - authorization:
          'nobody':
            - job-read
            - job-discover
      - build-blocker:
         blocking-jobs:
           - "tempest-cleanup-operator"
         block-level: 'GLOBAL'
    publishers:
      - trigger:
          project: 'tempest-cleanup-operator'
          threshold: 'FAILURE'


- job-template:
    name: tempest-{name}-check-{site}
    defaults: global
    node: tempest
    concurrent: true
    scm:
      - git:
         url: ssh://review.rc.nectar.org.au:29418/internal/nectar-testing.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
    builders:
      - tempest-check-whitelist-noparam:
          check: '{job}'
          whitelist: '{whitelist}'
          cloud: '{cloud}'
          site: '{site}'
    properties:
      - authorization:
          'nobody':
            - job-read
            - job-discover


- job-template:
    name: '{name}-r10k-diff-catalog'
    defaults: global
    node: internal
    quiet-period: 30

    properties:
      - build-blocker:
          blocking-jobs:
            - "{name}-r10k-deploy"
          block-level: 'GLOBAL'
      - lockable-resources:
          resources: 'diff-catalog-{r10k_host}'


    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event:
                exclude-no-code-change: true
            - change-restored-event
            - comment-added-contains-event:
                 comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - r10k-diff-catalog-control-repo:
          r10k_host: '{r10k_host}'

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'
      - ansicolor


- job-template:
    name: tempest-{name}-check-site-agnostic
    defaults: global
    node: tempest
    concurrent: true
    scm:
      - git:
         url: ssh://review.rc.nectar.org.au:29418/internal/nectar-testing.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
    builders:
      - tempest-check-whitelist-site-agnostic:
          check: '{name}'
          whitelist: '{whitelist}'
    parameters:
      - choice:
          name: 'CLOUD'
          choices:
            - production
            - testing
            - development
          description: "Cloud to run tempest on (Production, Test, Dev). Leave as Production if unsure."
    properties:
      - authorization:
          'nobody':
            - job-read
            - job-discover
      - build-blocker:
         blocking-jobs:
           - "tempest-cleanup-operator"
         block-level: 'GLOBAL'
    publishers:
      - trigger:
          project: 'tempest-cleanup-operator'
          threshold: 'FAILURE'

- job-template:
    name: tempest-{name}-check-site-agnostic-{cloud}
    defaults: global
    node: tempest
    concurrent: true
    scm:
      - git:
         url: ssh://review.rc.nectar.org.au:29418/internal/nectar-testing.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
    builders:
      - tempest-check-whitelist-site-agnostic-noparam:
          check: '{job}'
          whitelist: '{whitelist}'
          cloud: '{cloud}'
    properties:
      - authorization:
          'nobody':
            - job-read
            - job-discover
      - build-blocker:
         blocking-jobs:
           - "tempest-cleanup-operator"
         block-level: 'GLOBAL'
    publishers:
      - trigger:
          project: 'tempest-cleanup-operator'
          threshold: 'FAILURE'


- job-template:
    name: '{name}-pypi-upload'
    defaults: global
    node: bionic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - pypi-upload

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - 'cd8b8dd3-b897-4ecb-985d-180d5b6f8498'
      - credentials-binding:
        - file:
           credential-id: dot-pypirc
           variable: PYPIRC

- job-template:
    name: '{name}-run-tests'
    defaults: global
    node: focal

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

    scm:
      - git:
          url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
          credentials-id: cd8b8dd3-b897-4ecb-985d-180d5b6f8498
          refspec: $GERRIT_REFSPEC
          branches:
            - origin/$GERRIT_BRANCH
          skip-tag: true
          wipe-workspace: false
          clean:
           after: true
          choosing-strategy: gerrit

    builders:
      - run-tests


- job-template:
    name: '{name}-devenv-cleanup'
    defaults: global
    project-type: pipeline
    sandbox: true

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/nectar/wallaby
          description: "The ref to use."
      - string:
          name: GERRIT_BRANCH
          default: nectar/wallaby
          description: "The branch to use."

    triggers:
      - gerrit:
          trigger-on:
              - change-abandoned-event
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

    dsl: |
      pipeline {{
        agent {{ label 'internal' }}
        environment {{
          KEYSTONE = credentials('66ae35f1-6e11-4b79-aa1d-f71e6ac752b4')
        }}
        stages {{
          stage('Cleanup') {{
            steps {{
              sh '''
              export OS_USERNAME=$KEYSTONE_USR
              export OS_PASSWORD=$KEYSTONE_PSW
              export OS_AUTH_URL=https://keystone.rc.nectar.org.au:5000/v3
              export OS_PROJECT_DOMAIN_NAME=Default
              export OS_USER_DOMAIN_NAME=Default
              export OS_IDENTITY_API_VERSION=3
              export OS_PROJECT_NAME=NeCTAR-Devs

              TAG_BASE=review-$GERRIT_CHANGE_NUMBER

              recordsets=`openstack recordset list dev.rc.nectar.org.au. | grep ${{TAG_BASE}} | awk '{{print $2}}'`
              for i in $recordsets
              do
                  openstack recordset delete dev.rc.nectar.org.au. $i
              done
              '''

              withKubeConfig([credentialsId: 'd6011820-5ff7-42de-9722-8fbf66aa479d',
                    serverUrl: 'https://k8s-api.dev.rc.nectar.org.au:6443',
              ]) {{
                sh '''
                  TAG_BASE=review-$GERRIT_CHANGE_NUMBER
                  namespaces=`kubectl get namespaces | grep ${{TAG_BASE}} | awk '{{print $1}}'`
                  for namespace in $namespaces
                  do
                      kubectl delete namespace $namespace
                  done
                  '''
              }}
            }}
          }}
        }}
      }}
