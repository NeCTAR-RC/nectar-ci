- job-template:
    name: '{name}-puppet-unit'
    defaults: global
    node: puppet

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'production'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'oldnova'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - puppet-lint
      - puppet-syntax

    publishers:
      - warnings:
          console-log-parsers:
            - Puppet-Lint

- job-template:
    name: '{name}-trusty-deb-package'
    defaults: global
    node: trusty-liberty

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - pbuilder-create:
          os_release: "trusty"
      - pbuilder-buildpackage:
          os_release: "trusty"

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

- job-template:
    name: '{name}-xenial-deb-package'
    defaults: global
    node: xenial-pike

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - pbuilder-create:
          os_release: "xenial"
      - pbuilder-buildpackage:
          os_release: "xenial"

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

- job-template:
    name: '{name}-focal-deb-package'
    defaults: global
    node: bionic-train

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'uom/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - pbuilder-create:
          os_release: "focal"
      - pbuilder-buildpackage:
          os_release: "focal"

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

- job-template:
    name: '{name}-bionic-deb-package'
    defaults: global
    node: bionic-queens

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'uom/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - pbuilder-create:
          os_release: "bionic"
      - pbuilder-buildpackage:
          os_release: "bionic"

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

- job-template:
    name: '{name}-stein-deb-package'
    defaults: global
    node: bionic-queens

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'uom/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - pbuilder-create:
          os_release: "stein"
      - pbuilder-buildpackage:
          os_release: "stein"

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

- job-template:
    name: '{name}-ocata-deb-package'
    defaults: global
    node: xenial-ocata

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - pbuilder-create:
          os_release: "ocata"
      - pbuilder-buildpackage:
          os_release: "ocata"

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'


- job-template:
    name: '{name}-os-deb-package'
    defaults: global
    node: bionic-queens

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'uom/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - os-pbuilder-create
      - os-pbuilder-buildpackage

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

# Temp to support xenial-queens
- job-template:
    name: '{name}-os-xenial-deb-package'
    defaults: global
    node: xenial-pike

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/queens'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'uom/queens'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/queens'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - os-pbuilder-create-xenial
      - os-pbuilder-buildpackage-xenial

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

# Temp to support bionic-ussuri
- job-template:
    name: '{name}-os-bionic-deb-package'
    defaults: global
    node: bionic-ussuri

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/ussuri'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'uom/ussuri'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/ussuri'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - os-pbuilder-create-bionic
      - os-pbuilder-buildpackage-bionic

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

- job-template:
    name: '{name}-yaml'
    defaults: global
    node: bionic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
          url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
          credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
          refspec: $GERRIT_REFSPEC
          branches:
            - origin/$GERRIT_BRANCH
          skip-tag: true
          wipe-workspace: false
          clean:
           after: true
          choosing-strategy: gerrit

    builders:
      - yaml-lint

- job-template:
    name: '{name}-dummy'
    defaults: global
    node: openstack

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - dummy

- job-template:
    name: '{name}-dummy-debian'
    defaults: global
    node: openstack

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - dummy

- job-template:
    name: '{name}-markdown'
    defaults: global
    node: openstack

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit


    builders:
      - markdown-lint


- job-template:
    name: '{name}-nodejs-test'
    defaults: global
    node: xenial

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - nodejs-test


- job-template:
    name: '{name}-jekyll-test-build'
    defaults: global
    node: bionic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - jekyll-test-build

    wrappers:
      - credentials-binding:
        - username-password-separated:
           credential-id: 96a5a52d-2ad9-4f6f-a9fa-76bd2d057416
           username: CREDENTIAL_ID
           password: CREDENTIAL_SECRET
        - username-password:
           credential-id: 2f00f9a5-00c3-42fe-82bf-cc787af1df8c
           variable: GERRIT_API


- job-template:
    name: '{name}-jekyll-html-check'
    defaults: global
    node: bionic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - jekyll-html-check


- job-template:
    name: '{name}-jekyll-test-build-cleanup'
    defaults: global
    node: openstack

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
            - change-abandoned-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - jekyll-test-build-cleanup

    wrappers:
      - credentials-binding:
        - username-password-separated:
           credential-id: 96a5a52d-2ad9-4f6f-a9fa-76bd2d057416
           username: CREDENTIAL_ID
           password: CREDENTIAL_SECRET


- job-template:
    name: '{name}-puppet-prod-review'
    defaults: global
    node: openstack

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - puppet-prod-review

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

- job-template:
    name: '{name}-site-deploy'
    defaults: global
    node: internal
    quiet-period: 15

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."
      - string:
          name: GERRIT_PROJECT
          default: '{organisation}/{name}'
          description: "The fully qualified project name."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - site-deploy

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

- job-template:
    name: '{name}-r10k-deploy'
    defaults: global
    node: internal

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
            - change-restored-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - r10k-deploy:
          r10k_host: '{r10k_host}'

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'
      - credentials-binding:
        - text:
           credential-id: 2810b63c-d4ec-47df-b8f4-660e7902a358
           variable: TOKEN


- job-template:
    name: '{name}-r10k-deploy-control-repo'
    defaults: global
    node: internal
    quiet-period: 30

    properties:
      - build-blocker:
          blocking-jobs:
            - "{name}-r10k-cleanup"
          block-level: 'GLOBAL'

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."
      - string:
          name: GERRIT_PROJECT
          default: '{organisation}/{name}'
          description: "The fully qualified project name."

    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - r10k-deploy-control-repo:
          puppet_host: '{puppet_host}'

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'
      - credentials-binding:
        - text:
           credential-id: 2810b63c-d4ec-47df-b8f4-660e7902a358
           variable: TOKEN


- job-template:
    name: '{name}-r10k-cleanup'
    defaults: global
    node: internal

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."
      - string:
          name: GERRIT_PROJECT
          default: '{organisation}/{name}'
          description: "The fully qualified project name."

    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
            - change-abandoned-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - r10k-cleanup:
          r10k_host: '{r10k_host}'

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'


- job-template:
    name: tempest-{name}-check
    defaults: global
    node: tempest
    concurrent: true
    scm:
      - git:
         url: ssh://review.rc.nectar.org.au:29418/internal/nectar-testing.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
    builders:
      - tempest-check-whitelist:
          check: '{name}'
          whitelist: '{whitelist}'
    parameters:
      - choice:
          name: 'CLOUD'
          choices:
            - production
            - testing
            - development
          description: "Cloud to run tempest on (Production, Test, Dev). Leave as Production if unsure."
      - choice:
          name: 'AVAILABILITY_ZONE'
          choices:
            - auckland
            - intersect-01
            - melbourne-qh2
            - melbourne-qh2-uom
            - monash-01
            - monash-02
            - monash-03
            - qld
            - swinburne-01
            - tasmania
            - tasmania-02
            - tasmania-s
            - coreservices
            - qh2-test
            - monash-test
            - lani
            - luna
          description: 'Availability zone.'
    properties:
      - authorization:
          'nobody':
            - job-read
            - job-discover


- job-template:
    name: tempest-{name}-check-{site}
    defaults: global
    node: tempest
    concurrent: true
    scm:
      - git:
         url: ssh://review.rc.nectar.org.au:29418/internal/nectar-testing.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
    builders:
      - tempest-check-whitelist-noparam:
          check: '{job}'
          whitelist: '{whitelist}'
          cloud: '{cloud}'
          site: '{site}'
    properties:
      - authorization:
          'nobody':
            - job-read
            - job-discover


- job-template:
    name: '{name}-r10k-diff-catalog'
    defaults: global
    node: internal
    quiet-period: 30

    properties:
      - build-blocker:
          blocking-jobs:
            - "{name}-r10k-deploy"
          block-level: 'GLOBAL'
      - lockable-resources:
          resources: 'diff-catalog-{r10k_host}'


    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event:
                exclude-no-code-change: true
            - change-restored-event
            - comment-added-contains-event:
                 comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - r10k-diff-catalog-control-repo:
          r10k_host: '{r10k_host}'

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'
      - ansicolor


- job-template:
    name: tempest-{name}-check-site-agnostic
    defaults: global
    node: tempest
    concurrent: true
    scm:
      - git:
         url: ssh://review.rc.nectar.org.au:29418/internal/nectar-testing.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
    builders:
      - tempest-check-whitelist-site-agnostic:
          check: '{name}'
          whitelist: '{whitelist}'
    parameters:
      - choice:
          name: 'CLOUD'
          choices:
            - production
            - testing
            - development
          description: "Cloud to run tempest on (Production, Test, Dev). Leave as Production if unsure."
    properties:
      - authorization:
          'nobody':
            - job-read
            - job-discover

- job-template:
    name: tempest-{name}-check-site-agnostic-{cloud}
    defaults: global
    node: tempest
    concurrent: true
    scm:
      - git:
         url: ssh://review.rc.nectar.org.au:29418/internal/nectar-testing.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
    builders:
      - tempest-check-whitelist-site-agnostic-noparam:
          check: '{job}'
          whitelist: '{whitelist}'
          cloud: '{cloud}'
    properties:
      - authorization:
          'nobody':
            - job-read
            - job-discover


- job-template:
    name: '{name}-pypi-upload'
    defaults: global
    node: bionic

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - pypi-upload

    publishers:
      !include: publisher.yaml.inc

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'
      - credentials-binding:
        - file:
           credential-id: dot-pypirc
           variable: PYPIRC
