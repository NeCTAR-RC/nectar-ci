- job-template:
    name: '{name}-puppet-unit'
    project-type: freestyle
    defaults: global
    node: trusty-icehouse

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on-patchset-uploaded-event: true
          trigger-on-draft-published-event: true
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean: true
         choosing-strategy: gerrit

    builders:
      - puppet-lint
      - puppet-syntax

    publishers:
      - warnings:
          console-log-parsers:
            - Puppet-Lint
      - ircbot:
          strategy: all
          message-type: summary-scm
          channels:
            - name: '#nectar-builds'
              notify-only: true


- job-template:
    name: '{name}-python-tox-{environment}'
    project-type: freestyle
    defaults: global
    node: trusty-icehouse

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on-patchset-uploaded-event: true
          trigger-on-draft-published-event: true
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'nectar/havana'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'nectar/icehouse'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean: true
         choosing-strategy: gerrit


    builders:
      - python-tox-{environment}

    publishers:
      - ircbot:
          strategy: all
          message-type: summary-scm
          channels:
            - name: '#nectar-builds'
              notify-only: true
      - cobertura:
          report-file: "coverage.xml"
          only-stable: "true"
          targets: {}


- job-group:
    name: 'deb-package'
    os_release:
      - icehouse
      - havana
    jobs:
      - '{name}-{os_release}-deb-package'


- job-group:
    name: 'icehouse-deb-package'
    os_release:
      - icehouse
    jobs:
      - '{name}-{os_release}-deb-package'


- job-template:
    name: '{name}-{os_release}-deb-package'
    project-type: freestyle
    defaults: global
    node: trusty-icehouse

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on-change-merged-event: true
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'nectar/havana'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'nectar/icehouse'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean: true
         choosing-strategy: gerrit

    builders:
      - pbuilder-create:
          os_release: "{os_release}"
      - pbuilder-buildpackage:
          os_release: "{os_release}"

    publishers:
      - ircbot:
          strategy: all
          message-type: summary-scm
          channels:
            - name: '#nectar-builds'
              notify-only: true


- job-template:
    name: '{name}-run-tests'
    project-type: freestyle
    defaults: global
    node: trusty-icehouse

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on-patchset-uploaded-event: true
          trigger-on-draft-published-event: true
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'nectar/icehouse'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean: true
         choosing-strategy: gerrit


    builders:
      - run-tests

    publishers:
      - ircbot:
          strategy: all
          message-type: summary-scm
          channels:
            - name: '#nectar-builds'
              notify-only: true
      - cobertura:
          report-file: "coverage.xml"
          only-stable: "true"
          targets: {}
