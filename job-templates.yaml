- job-template:
    name: '{name}-puppet-unit'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - puppet-lint
      - puppet-syntax

    publishers:
      - warnings:
          console-log-parsers:
            - Puppet-Lint

- job-template:
    name: '{name}-trusty-deb-package'
    project-type: freestyle
    defaults: global
    node: trusty-liberty

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - pbuilder-create:
          os_release: "liberty"
      - pbuilder-buildpackage:
          os_release: "liberty"

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

- job-template:
    name: '{name}-xenial-deb-package'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'debian'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - pbuilder-create:
          os_release: "mitaka"
      - pbuilder-buildpackage:
          os_release: "mitaka"

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

- job-template:
    name: '{name}-os-deb-package'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'debian/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - os-pbuilder-checkout
      - os-pbuilder-create
      - os-pbuilder-buildpackage

    wrappers:
      - ssh-agent-credentials:
          users:
              - '4946c3a5-9f5e-4eac-9ec4-90e1e348db14'

- job-template:
    name: '{name}-run-tests'
    project-type: freestyle
    defaults: global
    node: trusty-icehouse

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - run-tests

    publishers:
      - cobertura:
          report-file: "coverage.xml"
          only-stable: "true"
          targets: {}

- job-template:
    name: 'image-build-{name}'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/nectar-images.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - image-builder:
         image_name: "{image_name}"
         job_name: "{name}"
         architecture: "{architecture}"
         os_distro: "{os_distro}"
         os_version: "{os_version}"
         default_user: "{default_user}"

    wrappers:
      - credentials-binding:
        - username-password:
           credential-id: 7a2e4b77-a292-47a1-b852-c0cfd9c1c383
           variable: IMAGE_BUILDER_CREDS
        - username-password:
           credential-id: 6c8091b5-0e7d-4be5-8458-4e5a999acdd6
           variable: IMAGE_PROMOTE_CREDS
        - file:
           credential-id: 10270abc-f1f9-47c7-ae66-114ae8246a71
           variable: SSH_TESTING_KEY

- job-template:
    name: 'image-build-rctest-{name}'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/nectar-images.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - image-builder-rctest:
         image_name: "{image_name}"
         job_name: "{name}"

    wrappers:
      - credentials-binding:
        - username-password:
           credential-id: 60a2f67f-93d4-4e72-900f-39cec212f07b
           variable: KEYSTONE_CREDS

- job-template:
    name: 'image-build-openstackbuilder-{name}'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/nectar-images.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - image-builder-openstack:
         image_name: "{image_name}"
         job_name: "{name}"
         architecture: "{architecture}"
         os_distro: "{os_distro}"
         os_version: "{os_version}"
         default_user: "{default_user}"

    wrappers:
      - credentials-binding:
        - username-password:
           credential-id: 7a2e4b77-a292-47a1-b852-c0cfd9c1c383
           variable: KEYSTONE_CREDS
        - file:
           credential-id: 10270abc-f1f9-47c7-ae66-114ae8246a71
           variable: SSH_TESTING_KEY

- job-template:
    name: '{name}-yaml'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
          url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
          credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
          refspec: $GERRIT_REFSPEC
          branches:
            - origin/$GERRIT_BRANCH
          skip-tag: true
          wipe-workspace: false
          clean:
           after: true
          choosing-strategy: gerrit

    builders:
      - yaml-lint

- job-template:
    name: '{name}-dummy'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - dummy

- job-template:
    name: '{name}-markdown'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit


    builders:
      - markdown-lint

- job-template:
    name: '{name}-rally'
    project-type: freestyle
    defaults: global
    node: upgrader
    concurrent: false
    quiet-period: 30
    properties:
      - authorization:
          'anonymous':
            - job-read
            - job-discover

    builders:
      - shell: |
          . /var/lib/jenkins/rally/bin/activate
          rally deployment use RCTest
          rally task start /var/lib/jenkins/rally-jobs/test/{name}.json
          rally task report --html --out output.html
          rally task report --junit --out output.xml
          rally task delete
    publishers:
      - html-publisher:
          name: "Rally Report"
          dir: "."
          files: "output.html"
          keep-all: true
          allow-missing: true
      - junit:
          results: output.xml

- job-template:
    name: '{name}-nodejs-test'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - nodejs-test

- job-template:
    name: '{name}-jekyll-build'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - patchset-created-event
              - comment-added-contains-event:
                   comment-contains-value: 'recheck'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true
          trigger-for-unreviewed-patches: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: false
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - rake-test

- job-template:
    name: '{name}-jekyll-deploy'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    triggers:
      - gerrit:
          trigger-on:
              - change-merged-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: '{organisation}/{name}'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: 'nectar/.*'
          silent: false
          escape-quotes: true

          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/{organisation}/{name}.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - jekyll-deploy

    wrappers:
      - credentials-binding:
        - username-password:
           credential-id: 6f958f1d-d42f-48c4-a8a5-72c37ae6e340
           variable: GITHUB_CREDS
