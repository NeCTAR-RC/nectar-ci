- project:
    name: centos-5-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'CentOS 5 x86_64'
         architecture: 'x86_64'
         os_distro: 'centos'
         os_version: '5'
         default_user: 'ec2-user'

- project:
    name: centos-6-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'CentOS 6 x86_64'
         architecture: 'x86_64'
         os_distro: 'centos'
         os_version: '6'
         default_user: 'ec2-user'

- project:
    name: centos-7-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'CentOS 7 x86_64'
         architecture: 'x86_64'
         os_distro: 'centos'
         os_version: '7'
         default_user: 'ec2-user'

- project:
    name: centos-7-x86_64-murano-agent
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'CentOS 7 x86_64 (pre-installed murano-agent)'
         architecture: 'x86_64'
         os_distro: 'centos'
         os_version: '7'
         default_user: 'ec2-user'

- project:
    name: debian-7-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Debian 7 (Wheezy) amd64'
         architecture: 'x86_64'
         os_distro: 'debian'
         os_version: '7'
         default_user: 'debian'

- project:
    name: debian-8-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Debian 8 (Jessie) amd64'
         architecture: 'x86_64'
         os_distro: 'debian'
         os_version: '8'
         default_user: 'debian'

- project:
    name: fedora-24-x86_64
    jobs:
      - 'image-build-openstackbuilder-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Fedora 24 x86_64'
         architecture: 'x86_64'
         os_distro: 'fedora'
         os_version: '24'
         default_user: 'fedora'

- project:
    name: fedora-25-x86_64
    jobs:
      - 'image-build-openstackbuilder-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Fedora 25 x86_64'
         architecture: 'x86_64'
         os_distro: 'fedora'
         os_version: '25'
         default_user: 'fedora'

- project:
    name: scientific-6-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Scientific Linux 6 x86_64'
         architecture: 'x86_64'
         os_distro: 'scientific'
         os_version: '6'
         default_user: 'ec2-user'

- project:
    name: ubuntu-14.04-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 14.04 (Trusty) amd64'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '14.04'
         default_user: 'ubuntu'

- project:
    name: ubuntu-14.04-x86_64-murano-agent
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 14.04 (Trusty) amd64 (pre-installed murano-agent)'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '14.04'
         default_user: 'ubuntu'

- project:
    name: ubuntu-16.04-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 16.04 LTS (Xenial) amd64'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '16.04'
         default_user: 'ubuntu'

- project:
    name: ubuntu-16.04-x86_64-murano-agent
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 16.04 LTS (Xenial) amd64 (pre-installed murano-agent)'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '16.04'
         default_user: 'ubuntu'

- project:
    name: opensuse-13.2-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'openSUSE 13.2 x86_64'
         architecture: 'x86_64'
         os_distro: 'opensuse'
         os_version: '13.2'
         default_user: 'ec2-user'

- project:
    name: opensuse-leap-42.1-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'openSUSE Leap 42.1 x86_64'
         architecture: 'x86_64'
         os_distro: 'opensuse'
         os_version: '42.1'
         default_user: 'ec2-user'

- project:
    name: jenkins-slave-ubuntu-14.04-x86_64
    jobs:
      - 'image-build-rctest-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: '{name}'
         default_user: 'ubuntu'

- project:
    name: jenkins-slave-ubuntu-16.04-x86_64
    jobs:
      - 'image-build-rctest-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: '{name}'
         default_user: 'ubuntu'


- job-template:
    name: 'image-build-{name}'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/nectar-images.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - image-builder:
         image_name: "{image_name}"
         job_name: "{name}"
         architecture: "{architecture}"
         os_distro: "{os_distro}"
         os_version: "{os_version}"
         default_user: "{default_user}"

    wrappers:
      - credentials-binding:
        - username-password-separated:
           credential-id: 7a2e4b77-a292-47a1-b852-c0cfd9c1c383
           username: IMAGE_BUILDER_USERNAME
           password: IMAGE_BUILDER_PASSWORD
        - username-password-separated:
           credential-id: 6c8091b5-0e7d-4be5-8458-4e5a999acdd6
           username: IMAGE_PROMOTE_USERNAME
           password: IMAGE_PROMOTE_PASSWORD
        - file:
           credential-id: 10270abc-f1f9-47c7-ae66-114ae8246a71
           variable: SSH_TESTING_KEY


- job-template:
    name: 'image-build-openstackbuilder-{name}'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/nectar-images.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - image-builder-openstack:
         image_name: "{image_name}"
         job_name: "{name}"
         architecture: "{architecture}"
         os_distro: "{os_distro}"
         os_version: "{os_version}"
         default_user: "{default_user}"

    wrappers:
      - credentials-binding:
        - username-password-separated:
           credential-id: 7a2e4b77-a292-47a1-b852-c0cfd9c1c383
           username: IMAGE_BUILDER_USERNAME
           password: IMAGE_BUILDER_PASSWORD
        - username-password-separated:
           credential-id: 6c8091b5-0e7d-4be5-8458-4e5a999acdd6
           username: IMAGE_PROMOTE_USERNAME
           password: IMAGE_PROMOTE_PASSWORD
        - file:
           credential-id: 10270abc-f1f9-47c7-ae66-114ae8246a71
           variable: SSH_TESTING_KEY


- job-template:
    name: 'image-build-rctest-{name}'
    project-type: freestyle
    defaults: global
    node: xenial-mitaka

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/nectar-images.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - image-builder-rctest:
         image_name: "{image_name}"
         job_name: "{name}"

    wrappers:
      - credentials-binding:
        - username-password:
           credential-id: 60a2f67f-93d4-4e72-900f-39cec212f07b
           variable: KEYSTONE_CREDS


- builder:
    name: 'image-builder'
    builders:
      - shell: |
          #!/bin/bash -xe
          BUILD_NAME="{job_name}_build_$BUILD_NUMBER"
          set +x
          export OS_USERNAME=$IMAGE_BUILDER_USERNAME
          export OS_PASSWORD=$IMAGE_BUILDER_PASSWORD
          set -x
          export OS_AUTH_URL=https://keystone.rc.nectar.org.au:5000/
          export OS_TENANT_ID=28eadf5ad64b42a4929b2fb7df99275c
          export OS_TENANT_NAME=NeCTAR-Images
          export OS_NO_CACHE=True
          jq ".builders[0].name = \"$BUILD_NAME\" | .builders[0].vm_name = \"$BUILD_NAME\"" {job_name}.json > ${{BUILD_NAME}}.json
          [ -d output-${{BUILD_NAME}} ] && rm -fr output-${{BUILD_NAME}}
          packer build -color=false -var-file=variables-nectar.json ${{BUILD_NAME}}.json
          rm ${{BUILD_NAME}}.json
          cd output-${{BUILD_NAME}}
          qemu-img convert -c -o compat=0.10 -O qcow2 ${{BUILD_NAME}} ${{BUILD_NAME}}.qcow2
          rm ${{BUILD_NAME}}
          IMAGE_ID=$(openstack image create -f value -c id --disk-format qcow2 --container-format bare --file ${{BUILD_NAME}}.qcow2 --property architecture="{architecture}" --property os_distro="{os_distro}" --property os_version="{os_version}" --property nectar_build=$BUILD_NUMBER --property nectar_name="{image_name}" "NeCTAR {image_name}")
          [[ "{job_name}" =~ "murano" ]] && glance image-update --property murano_image_info='{{"title": "NeCTAR {image_name}", "type": "linux"}}' $IMAGE_ID
          set +e
          INSTANCE_ID=$(openstack server create -f value -c id --image $IMAGE_ID --flavor m1.small --key-name jenkins-image-testing "test_$BUILD_NAME")
          USER_ACCOUNT={default_user}
          set +e
          i=0
          while [ $i -le 20 ]; do
              STATUS=$(openstack server show -f value -c status $INSTANCE_ID)
              [ "$STATUS" = "ACTIVE" ] && break
              if [ $i -ge 20 ] || [ "$STATUS" = "ERROR" ]; then
                  openstack server delete $INSTANCE_ID; exit 1
              fi
              i=$((i+1))
              sleep 10
          done
          IP_ADDRESS=$(openstack server show -f value -c accessIPv4 $INSTANCE_ID)
          chmod 600 $SSH_TESTING_KEY
          j=0
          while [ $j -le 20 ]; do
              ssh -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null -i $SSH_TESTING_KEY $USER_ACCOUNT@$IP_ADDRESS exit && break
              if [ $j -ge 20 ]; then
                  openstack server delete $INSTANCE_ID; exit 1
              fi
              j=$((j+1))
              sleep 10
          done
          ssh -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null -i $SSH_TESTING_KEY $USER_ACCOUNT@$IP_ADDRESS 'sleep 120; /bin/bash /usr/nectar/run_tests.sh'
          TEST_RESULT=$?
          openstack server delete $INSTANCE_ID
          set +x
          if [ $TEST_RESULT -eq 0 ]; then
              export OS_AUTH_URL=https://keystone.rc.nectar.org.au:5000/v2.0/
              export OS_USERNAME=$IMAGE_PROMOTE_USERNAME
              export OS_PASSWORD=$IMAGE_PROMOTE_PASSWORD
              echo "================================================================================"
              echo "  NeCTAR {image_name} v$BUILD_NUMBER build successful!"
              echo "  Image ID: $IMAGE_ID"
              echo "================================================================================"
              set -x
              hivemind glance.promote --no-dry-run -t NeCTAR-Images-Archive $IMAGE_ID && exit 0
          fi
          exit 1


- builder:
    name: 'image-builder-openstack'
    builders:
      - shell: |
          #!/bin/bash -xe
          BUILD_NAME="{job_name}_build_$BUILD_NUMBER"
          set +x
          export OS_USERNAME=$IMAGE_BUILDER_USERNAME
          export OS_PASSWORD=$IMAGE_BUILDER_PASSWORD
          set -x
          export OS_AUTH_URL=https://keystone.rc.nectar.org.au:5000/
          export OS_TENANT_ID=28eadf5ad64b42a4929b2fb7df99275c
          export OS_TENANT_NAME=NeCTAR-Images
          export OS_NO_CACHE=True
          jq ".builders[0].image_name = \"$BUILD_NAME\"" {job_name}.json > ${{BUILD_NAME}}.json
          packer build -color=false -var-file=variables-nectar.json ${{BUILD_NAME}}.json
          rm ${{BUILD_NAME}}.json
          openstack image save --file ${{BUILD_NAME}}_large.qcow2 $BUILD_NAME
          qemu-img convert -c -o compat=0.10 -O qcow2 ${{BUILD_NAME}}_large.qcow2 ${{BUILD_NAME}}.qcow2
          rm ${{BUILD_NAME}}_large.qcow2
          IMAGE_ID=$(openstack image create -f value -c id --disk-format qcow2 --container-format bare --file ${{BUILD_NAME}}.qcow2 --property architecture="{architecture}" --property os_distro="{os_distro}" --property os_version="{os_version}" --property nectar_build=$BUILD_NUMBER --property nectar_name="{image_name}" "NeCTAR {image_name}")
          INSTANCE_ID=$(openstack server create -f value -c id --image $IMAGE_ID --flavor m1.small --key-name jenkins-image-testing "test_$BUILD_NAME")
          USER_ACCOUNT=$(jq -r '.builders[0].ssh_username' {job_name}.json)
          set +e
          i=0
          while [ $i -le 20 ]; do
              STATUS=$(openstack server show -f value -c status $INSTANCE_ID)
              [ "$STATUS" = "ACTIVE" ] && break
              if [ $i -ge 20 ] || [ "$STATUS" = "ERROR" ]; then
                  openstack server delete $INSTANCE_ID; exit 1
              fi
              i=$((i+1))
              sleep 10
          done
          IP_ADDRESS=$(openstack server show -f value -c accessIPv4 $INSTANCE_ID)
          chmod 600 $SSH_TESTING_KEY
          j=0
          while [ $j -le 20 ]; do
              ssh -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null -i $SSH_TESTING_KEY $USER_ACCOUNT@$IP_ADDRESS exit && break
              if [ $j -ge 20 ]; then
                  openstack server delete $INSTANCE_ID; exit 1
              fi
              j=$((j+1))
              sleep 10
          done
          ssh -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null -i $SSH_TESTING_KEY $USER_ACCOUNT@$IP_ADDRESS 'sleep 120; /bin/bash /usr/nectar/run_tests.sh'
          TEST_RESULT=$?
          openstack server delete $INSTANCE_ID
          set +x
          if [ $TEST_RESULT -eq 0 ]; then
              export OS_AUTH_URL=https://keystone.rc.nectar.org.au:5000/v2.0/
              export OS_USERNAME=$IMAGE_PROMOTE_USERNAME
              export OS_PASSWORD=$IMAGE_PROMOTE_PASSWORD
              echo "================================================================================"
              echo "  NeCTAR {image_name} v$BUILD_NUMBER build successful!"
              echo "  Image ID: $IMAGE_ID"
              echo "================================================================================"
              set -x
              hivemind glance.promote --no-dry-run -t NeCTAR-Images-Archive $IMAGE_ID && exit 0
          fi
          exit 1


- builder:
    name: 'image-builder-rctest'
    builders:
      - shell: |
          [ -d output-{job_name} ] && rm -fr output-{job_name}
          packer build -color=false -var-file=variables-nectar.json {job_name}.json
          cd output-{job_name}
          qemu-img convert -c -o compat=0.10 -O qcow2 {job_name} {job_name}.qcow2
          rm {job_name}
          set +x
          export OS_AUTH_URL=https://keystone.test.rc.nectar.org.au:5000/v2.0/
          export OS_TENANT_ID=704fdb05a2f645ac8dbf4fb1222bf267
          export OS_TENANT_NAME=nectar-ci
          export OS_USERNAME=$(echo $IMAGE_BUILDER_CREDS | cut -f1 -d:)
          export OS_PASSWORD=$(echo $IMAGE_BUILDER_CREDS | cut -f2 -d:)
          export OS_NO_CACHE=True

          IMAGE_ID=$(glance --os-image-api-version=1 image-create --disk-format qcow2 --container-format bare --name "{image_name}-v$BUILD_NUMBER" --file "{job_name}.qcow2" | grep " id " |  cut -d '|' -f3 | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//');

          echo "================================================================================"
          echo ""
          echo "  NeCTAR {image_name} v$BUILD_NUMBER build successful!"
          echo ""
          echo "  To use this new image in Jenkins, go to:"
          echo "      https://jenkins.rc.nectar.org.au/configure"
          echo ""
          echo "  and set the 'Cloud Instance Templates Image ID' value to:"
          echo "      {image_name}"
          echo ""
          echo "================================================================================"
