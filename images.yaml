- project:
    name: centos-6-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'CentOS 6 x86_64'
         architecture: 'x86_64'
         os_distro: 'centos'
         os_version: '6'
         default_user: 'ec2-user'

- project:
    name: centos-7-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'CentOS 7 x86_64'
         architecture: 'x86_64'
         os_distro: 'centos'
         os_version: '7'
         default_user: 'ec2-user'

- project:
    name: centos-7-x86_64-murano-agent
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'CentOS 7 x86_64 (pre-installed murano-agent)'
         architecture: 'x86_64'
         os_distro: 'centos'
         os_version: '7'
         default_user: 'ec2-user'

- project:
    name: debian-8-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Debian 8 (Jessie) amd64'
         architecture: 'x86_64'
         os_distro: 'debian'
         os_version: '8'
         default_user: 'debian'

- project:
    name: debian-9-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Debian 9 (Stretch) amd64'
         architecture: 'x86_64'
         os_distro: 'debian'
         os_version: '9'
         default_user: 'debian'

- project:
    name: fedora-27-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Fedora 27 x86_64'
         architecture: 'x86_64'
         os_distro: 'fedora'
         os_version: '27'
         default_user: 'fedora'

- project:
    name: fedora-28-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Fedora 28 x86_64'
         architecture: 'x86_64'
         os_distro: 'fedora'
         os_version: '28'
         default_user: 'fedora'

- project:
    name: scientific-6-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Scientific Linux 6 x86_64'
         architecture: 'x86_64'
         os_distro: 'scientific'
         os_version: '6'
         default_user: 'ec2-user'

- project:
    name: ubuntu-14.04-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 14.04 (Trusty) amd64'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '14.04'
         default_user: 'ubuntu'

- project:
    name: ubuntu-14.04-x86_64-murano-agent
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 14.04 (Trusty) amd64 (pre-installed murano-agent)'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '14.04'
         default_user: 'ubuntu'

- project:
    name: ubuntu-16.04-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 16.04 LTS (Xenial) amd64'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '16.04'
         default_user: 'ubuntu'

- project:
    name: ubuntu-16.04-x86_64-murano-agent
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 16.04 LTS (Xenial) amd64 (pre-installed murano-agent)'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '16.04'
         default_user: 'ubuntu'

- project:
    name: ubuntu-17.10-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 17.10 (Artful) amd64'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '17.10'
         default_user: 'ubuntu'

- project:
    name: ubuntu-18.04-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 18.04 LTS (Bionic) amd64'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '18.04'
         default_user: 'ubuntu'

- project:
    name: ubuntu-18.04-x86_64-murano-agent
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 18.04 LTS (Bionic) amd64 (pre-installed murano-agent)'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '18.04'
         default_user: 'ubuntu'

- project:
    name: ubuntu-18.04-x86_64-murano-docker
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Ubuntu 18.04 LTS (Bionic) amd64 (pre-installed murano-agent with Docker)'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '18.04'
         default_user: 'ubuntu'

- project:
    name: opensuse-leap-42.3-x86_64
    jobs:
      - 'image-build-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'openSUSE Leap 42.3 x86_64'
         architecture: 'x86_64'
         os_distro: 'opensuse'
         os_version: '42.3'
         default_user: 'ec2-user'

- project:
    name: mysql-5.7-ubuntu-16.04-x86_64
    jobs:
      - 'image-build-trove-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Trove MySQL 5.7 (Ubuntu 16.04 LTS)'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '16.04'
         datastore_name: 'MySQL'
         datastore_type: 'mysql'
         datastore_version: '5.7'

- project:
    name: postgresql-9.6-ubuntu-16.04-x86_64
    jobs:
      - 'image-build-trove-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Trove PostgreSQL 9.6 (Ubuntu 16.04 LTS)'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '16.04'
         datastore_name: 'PostgreSQL'
         datastore_type: 'postgresql'
         datastore_version: '9.6'

- project:
    name: spark-2.1.0-ubuntu-14.04-x86_64
    jobs:
      - 'image-build-sahara-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: 'Sahara Spark 2.1.0 (Ubuntu 14.04 LTS)'
         architecture: 'x86_64'
         os_distro: 'ubuntu'
         os_version: '14.04'
         plugin: 'spark'
         spark_version: '2.1.0'
         hadoop_version: 'N/A'
         cloud_user: 'ubuntu'
         build_name: 'ubuntu_sahara_spark_latest'

- project:
    name: jenkins-slave-ubuntu-14.04-x86_64
    jobs:
      - 'image-build-rctest-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: '{name}'
         default_user: 'ubuntu'

- project:
    name: jenkins-slave-ubuntu-16.04-x86_64
    jobs:
      - 'image-build-rctest-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: '{name}'
         default_user: 'ubuntu'

- project:
    name: jenkins-slave-ubuntu-18.04-x86_64
    jobs:
      - 'image-build-rctest-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: '{name}'
         default_user: 'ubuntu'

- project:
    name: undercloud-ubuntu-16.04-x86_64
    jobs:
      - 'image-build-undercloud-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: '{name}'
         default_user: 'root'

- project:
    name: undercloud-ubuntu-18.04-x86_64
    jobs:
      - 'image-build-undercloud-{name}':
         access: 'nobody'
         organisation: 'NeCTAR-RC'
         image_name: '{name}'
         default_user: 'root'


- job-template:
    name: 'image-build-{name}'
    defaults: global
    node: xenial

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."
      - string:
          name: 'AVAILABILITY_ZONE'
          default: ''
          description: 'Nova availability zone. <a href="https://wiki.rc.nectar.org.au/wiki/Tempest#AVAILABILITY_ZONES">List of Availability Zones</a>'

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/nectar-images.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - image-builder:
         image_name: "{image_name}"
         job_name: "{name}"
         architecture: "{architecture}"
         os_distro: "{os_distro}"
         os_version: "{os_version}"
         default_user: "{default_user}"

    wrappers:
      - credentials-binding:
        - username-password-separated:
           credential-id: 7a2e4b77-a292-47a1-b852-c0cfd9c1c383
           username: IMAGE_BUILDER_USERNAME
           password: IMAGE_BUILDER_PASSWORD
        - username-password-separated:
           credential-id: 6c8091b5-0e7d-4be5-8458-4e5a999acdd6
           username: IMAGE_PROMOTE_USERNAME
           password: IMAGE_PROMOTE_PASSWORD
        - file:
           credential-id: 10270abc-f1f9-47c7-ae66-114ae8246a71
           variable: SSH_TESTING_KEY


- job-template:
    name: 'image-build-trove-{name}'
    defaults: global
    node: xenial

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/nectar-images.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - image-builder-trove:
         image_name: "{image_name}"
         job_name: "{name}"
         architecture: "{architecture}"
         os_distro: "{os_distro}"
         os_version: "{os_version}"
         datastore_name: "{datastore_name}"
         datastore_type: "{datastore_type}"
         datastore_version: "{datastore_version}"

    wrappers:
      - credentials-binding:
        - username-password-separated:
           credential-id: 7a2e4b77-a292-47a1-b852-c0cfd9c1c383
           username: IMAGE_BUILDER_USERNAME
           password: IMAGE_BUILDER_PASSWORD


- job-template:
    name: 'image-build-sahara-{name}'
    defaults: global
    node: xenial

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/nectar/pike
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: nectar/pike
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/sahara-image-elements.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - image-builder-sahara:
         image_name: "{image_name}"
         job_name: "{name}"
         architecture: "{architecture}"
         os_distro: "{os_distro}"
         os_version: "{os_version}"
         plugin: "{plugin}"
         spark_version: "{spark_version}"
         hadoop_version: "{hadoop_version}"
         cloud_user: "{cloud_user}"
         build_name: "{build_name}"

    wrappers:
      - credentials-binding:
        - username-password-separated:
           credential-id: 7a2e4b77-a292-47a1-b852-c0cfd9c1c383
           username: IMAGE_BUILDER_USERNAME
           password: IMAGE_BUILDER_PASSWORD


- job-template:
    name: 'image-build-rctest-{name}'
    defaults: global
    node: xenial

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/nectar-images.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - image-builder-rctest:
         image_name: "{image_name}"
         job_name: "{name}"

    wrappers:
      - credentials-binding:
        - username-password:
           credential-id: 60a2f67f-93d4-4e72-900f-39cec212f07b
           variable: KEYSTONE_CREDS


- job-template:
    name: 'image-build-undercloud-{name}'
    defaults: global
    node: xenial

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: refs/heads/master
          description: "The default ref to test."
      - string:
          name: GERRIT_BRANCH
          default: master
          description: "The default branch to test."

    properties:
      - authorization:
          '{access}':
            - job-read
            - job-discover

    scm:
      - git:
         url: ssh://jenkins@review.rc.nectar.org.au:29418/NeCTAR-RC/nectar-images.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
         refspec: $GERRIT_REFSPEC
         branches:
          - origin/$GERRIT_BRANCH
         skip-tag: true
         wipe-workspace: true
         clean:
           after: true
         choosing-strategy: gerrit

    builders:
      - image-builder-undercloud:
         image_name: "{image_name}"
         job_name: "{name}"

    wrappers:
      - credentials-binding:
        - username-password:
           credential-id: 7a2e4b77-a292-47a1-b852-c0cfd9c1c383
           variable: KEYSTONE_CREDS


- builder:
    name: 'image-builder'
    builders:
      - shell: |
          #!/bin/bash -e
          BUILD_NAME="{job_name}_build_$BUILD_NUMBER"
          FACT_DIR=$WORKSPACE/ansible/.facts
          export OS_USERNAME=$IMAGE_BUILDER_USERNAME
          export OS_PASSWORD=$IMAGE_BUILDER_PASSWORD
          export OS_AUTH_URL=https://keystone.rc.nectar.org.au:5000/
          export OS_PROJECT_DOMAIN_NAME=Default
          export OS_USER_DOMAIN_NAME=Default
          export OS_IDENTITY_API_VERSION=3
          if [[ "{job_name}" =~ "murano" ]]; then
              export OS_PROJECT_NAME=murano
          else
              export OS_PROJECT_NAME=NeCTAR-Images
          fi
          export OS_TENANT_NAME=$OS_PROJECT_NAME  # promote needs this, need to fix hivemind
          BUILDER_TYPE=$(jq -r ".builders[0].type" {job_name}.json)
          if [ "$BUILDER_TYPE" == "qemu" ]; then
              jq ".builders[0].name = \"$BUILD_NAME\" | .builders[0].vm_name = \"$BUILD_NAME\"" {job_name}.json > ${{BUILD_NAME}}.json
              USER_ACCOUNT={default_user}
          else
              jq ".builders[0].image_name = \"$BUILD_NAME\"" {job_name}.json > ${{BUILD_NAME}}.json
              USER_ACCOUNT=$(jq -r '.builders[0].ssh_username' {job_name}.json)
              [ "$USER_ACCOUNT" == "centos" ] && USER_ACCOUNT=ec2-user
          fi
          rm -fr ansible/.facts
          packer build -color=false ${{BUILD_NAME}}.json
          rm ${{BUILD_NAME}}.json
          if [ "$BUILDER_TYPE" == "qemu" ]; then
              cd output-${{BUILD_NAME}}
              qemu-img convert -c -o compat=0.10 -O qcow2 ${{BUILD_NAME}} ${{BUILD_NAME}}.qcow2
              rm -f ${{BUILD_NAME}}
          else
              openstack image save --file ${{BUILD_NAME}}_large.qcow2 $BUILD_NAME
              openstack image delete $BUILD_NAME
              qemu-img convert -c -o compat=0.10 -O qcow2 ${{BUILD_NAME}}_large.qcow2 ${{BUILD_NAME}}.qcow2
              rm ${{BUILD_NAME}}_large.qcow2
          fi
          echo "Creating image..."
          IMAGE_ID=$(openstack image create -f value -c id --disk-format qcow2 --container-format bare --file ${{BUILD_NAME}}.qcow2 --property hw_qemu_guest_agent=yes --property architecture="{architecture}" --property os_distro="{os_distro}" --property os_version="{os_version}" --property default_user="{default_user}" --property nectar_build=$BUILD_NUMBER --property nectar_name="{image_name}" "NeCTAR {image_name}")
          echo "Image $IMAGE_ID created!"
          if [ -d $FACT_DIR ]; then
              for FACT in $(ls $FACT_DIR); do
                  echo "Adding $FACT property to image ..."
                  openstack image set --property $FACT="$(cat $FACT_DIR/$FACT)" $IMAGE_ID
              done
          fi
          if [[ "{job_name}" =~ "murano" ]]; then
              echo "Adding Murano properties to image ..."
              MURANO_TYPE=linux
              [[ "{job_name}" =~ "docker" ]] && MURANO_TYPE="linux.docker"
              openstack image set --property murano_image_info="{{\"title\": \"NeCTAR {image_name}\", \"type\": \"$MURANO_TYPE\"}}" $IMAGE_ID
          fi
          openstack image show $IMAGE_ID
          echo "Creating instance..."
          [ -z $AVAILABILITY_ZONE ] || AZ_OPT="--availability-zone $AVAILABILITY_ZONE"
          INSTANCE_ID=$(openstack server create -f value -c id --image $IMAGE_ID --flavor m1.small --security-group image-build --key-name jenkins-image-testing $AZ_OPT "test_$BUILD_NAME")
          echo "Found instance ID: $INSTANCE_ID"
          RETRIES=10
          i=1
          while [ $i -le $RETRIES ]; do
              STATUS=$(openstack server show -f value -c status $INSTANCE_ID)
              echo "Instance is $STATUS ($i/$RETRIES)..."
              [ "$STATUS" = "ACTIVE" ] && break
              if [ $i -ge $RETRIES ]; then
                  echo "ERROR: Limit reached, cleaning up..."
                  openstack image delete $IMAGE_ID
                  openstack server delete $INSTANCE_ID
                  exit 1
              fi
              if [ "$STATUS" = "ERROR" ]; then
                  echo "Recreating instance due to error: $(openstack server show -f value -c fault $INSTANCE_ID)"
                  openstack server delete $INSTANCE_ID
                  INSTANCE_ID=$(openstack server create -f value -c id --image $IMAGE_ID --flavor m1.small --security-group image-build --key-name jenkins-image-testing $AZ_OPT "test_$BUILD_NAME")
                  echo "Found instance ID: $INSTANCE_ID"
              fi
              i=$((i+1))
              sleep 30
          done
          openstack server show $INSTANCE_ID
          IP_ADDRESS=$(openstack server show -f value -c accessIPv4 $INSTANCE_ID)
          chmod 600 $SSH_TESTING_KEY
          sleep 120 # time to settle for SSH key/fail2ban
          RETRIES=5
          j=1
          while [ $j -le $RETRIES ]; do
              echo "Checking for SSH to $IP_ADDRESS ($j/$RETRIES)..."
              ssh -oLogLevel=error -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null -i $SSH_TESTING_KEY $USER_ACCOUNT@$IP_ADDRESS exit && break
              if [ $j -ge $RETRIES ]; then
                  nova console-log $INSTANCE_ID
                  echo "ERROR: Limit reached, cleaning up..."
                  openstack image delete $IMAGE_ID
                  openstack server delete $INSTANCE_ID
                  exit 1
              fi
              j=$((j+1))
              sleep 60
          done
          echo "Running tests..."
          sleep 120 # time for cloud-init to complete
          ssh -oLogLevel=error -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null -i $SSH_TESTING_KEY $USER_ACCOUNT@$IP_ADDRESS '/bin/bash /usr/nectar/run_tests.sh'
          TEST_RESULT=$?
          openstack server delete $INSTANCE_ID
          if [ $TEST_RESULT -eq 0 ]; then
              export OS_USERNAME=$IMAGE_PROMOTE_USERNAME
              export OS_PASSWORD=$IMAGE_PROMOTE_PASSWORD
              echo "================================================================================"
              echo "  NeCTAR {image_name} v$BUILD_NUMBER build successful!"
              echo "  Image ID: $IMAGE_ID"
              echo "================================================================================"
              hivemind glance.promote --no-dry-run --project NeCTAR-Images-Archive $IMAGE_ID && exit 0
          fi
          exit 1


- builder:
    name: 'image-builder-trove'
    builders:
      - shell: |
          #!/bin/bash -e
          export OS_USERNAME=$IMAGE_BUILDER_USERNAME
          export OS_PASSWORD=$IMAGE_BUILDER_PASSWORD
          export OS_AUTH_URL=https://keystone.rc.nectar.org.au:5000/v3
          export OS_PROJECT_DOMAIN_NAME=Default
          export OS_USER_DOMAIN_NAME=Default
          export OS_IDENTITY_API_VERSION=3
          export OS_PROJECT_NAME=trove
          BUILD_NAME="trove-{job_name}_build_$BUILD_NUMBER"
          jq ".builders[0].name = \"$BUILD_NAME\" | .builders[0].vm_name = \"$BUILD_NAME\"" trove-{job_name}.json > ${{BUILD_NAME}}.json
          packer build -color=false ${{BUILD_NAME}}.json
          rm ${{BUILD_NAME}}.json
          cd output-${{BUILD_NAME}}
          echo "Converting image to qcow2..."
          qemu-img convert -c -o compat=0.10 -O qcow2 ${{BUILD_NAME}} ${{BUILD_NAME}}.qcow2
          rm -f ${{BUILD_NAME}}
          echo "Creating OpenStack image..."
          IMAGE_ID=$(openstack image create -f value -c id --disk-format qcow2 --container-format bare --file ${{BUILD_NAME}}.qcow2 --property hw_qemu_guest_agent=yes --property architecture="{architecture}" --property os_distro="{os_distro}" --property os_version="{os_version}" --property datastore_type="{datastore_type}" --property datastore_version="{datastore_version}" --property nectar_build=$BUILD_NUMBER --property nectar_name="{image_name}" "NeCTAR {image_name}")
          echo "Image $IMAGE_ID created!"
          openstack image show $IMAGE_ID
          echo "================================================================================"
          echo ""
          echo "  NeCTAR {image_name} v$BUILD_NUMBER build successful!"
          echo ""
          echo "  To use this new image in Trove, from a controller run:"
          echo "     trove-manage datastore_update {datastore_name} ''"
          echo "     trove-manage datastore_version_update {datastore_name} {datastore_version}-$BUILD_NUMBER {datastore_type} $IMAGE_ID '' 1"
          echo "     trove-manage datastore_update {datastore_name} {datastore_version}-$BUILD_NUMBER"
          echo ""
          echo "  For steps on how to clean up the older images, see the instuctions at:"
          echo "     https://wiki.rc.nectar.org.au/wiki/Trove"
          echo ""
          echo "================================================================================"

- builder:
    name: 'image-builder-rctest'
    builders:
      - shell: |
          #!/bin/bash -xe
          BUILD_NAME="{job_name}_build_$BUILD_NUMBER"
          set +x
          export OS_USERNAME=$(echo $KEYSTONE_CREDS | cut -f1 -d:)
          export OS_PASSWORD=$(echo $KEYSTONE_CREDS | cut -f2 -d:)
          set -x
          export OS_AUTH_URL=https://keystone.test.rc.nectar.org.au:5000/v2.0/
          export OS_TENANT_ID=704fdb05a2f645ac8dbf4fb1222bf267
          export OS_TENANT_NAME=nectar-ci
          export OS_NO_CACHE=True

          jq ".builders[0].name = \"$BUILD_NAME\" | .builders[0].vm_name = \"$BUILD_NAME\"" {job_name}.json > ${{BUILD_NAME}}.json
          packer build -color=false ${{BUILD_NAME}}.json
          rm ${{BUILD_NAME}}.json
          cd output-${{BUILD_NAME}}
          qemu-img convert -c -o compat=0.10 -O qcow2 ${{BUILD_NAME}} ${{BUILD_NAME}}.qcow2
          rm -f ${{BUILD_NAME}}
          IMAGE_ID=$(openstack image create -f value -c id --disk-format qcow2 --container-format bare --file ${{BUILD_NAME}}.qcow2 "{image_name}-v$BUILD_NUMBER")
          rm ${{BUILD_NAME}}.qcow2
          set +x
          echo "================================================================================"
          echo ""
          echo "  NeCTAR {image_name} v$BUILD_NUMBER build successful!"
          echo ""
          echo "  To use this new image in Jenkins, go to:"
          echo "      https://jenkins.rc.nectar.org.au/configure"
          echo ""
          echo "  and set the 'Cloud Instance Templates Image ID' value to:"
          echo "      {image_name}-v$BUILD_NUMBER"
          echo ""
          echo "================================================================================"


- builder:
    name: 'image-builder-undercloud'
    builders:
      - shell: |
          #!/bin/bash -xe
          BUILD_NAME="{job_name}_build_$BUILD_NUMBER"
          set +x
          export OS_USERNAME=$(echo $KEYSTONE_CREDS | cut -f1 -d:)
          export OS_PASSWORD=$(echo $KEYSTONE_CREDS | cut -f2 -d:)
          set -x
          export OS_AUTH_URL=https://keystone.rc.nectar.org.au:5000/v3/
          export OS_TENANT_NAME=NeCTAR-Devs
          export OS_NO_CACHE=True

          jq ".builders[0].name = \"$BUILD_NAME\" | .builders[0].vm_name = \"$BUILD_NAME\"" {job_name}.json > ${{BUILD_NAME}}.json
          packer build -color=false ${{BUILD_NAME}}.json
          rm ${{BUILD_NAME}}.json
          cd output-${{BUILD_NAME}}
          qemu-img convert -c -o compat=0.10 -O qcow2 ${{BUILD_NAME}} ${{BUILD_NAME}}.qcow2
          rm -f ${{BUILD_NAME}}
          IMAGE_ID=$(openstack image create -f value -c id --disk-format qcow2 --container-format bare --file ${{BUILD_NAME}}.qcow2 "{image_name}-v$BUILD_NUMBER")
          rm ${{BUILD_NAME}}.qcow2
          set +x
          echo "================================================================================"
          echo ""
          echo "  NeCTAR UnderCloud {image_name} v$BUILD_NUMBER build successful!"
          echo ""
          echo "================================================================================"


- builder:
    name: 'image-builder-sahara'
    builders:
      - shell: |
          #!/bin/bash -e
          export OS_USERNAME=$IMAGE_BUILDER_USERNAME
          export OS_PASSWORD=$IMAGE_BUILDER_PASSWORD
          export OS_AUTH_URL=https://keystone.rc.nectar.org.au:5000/v3
          export OS_PROJECT_DOMAIN_NAME=Default
          export OS_USER_DOMAIN_NAME=Default
          export OS_IDENTITY_API_VERSION=3
          export OS_PROJECT_NAME=sahara
          echo "Building image to qcow2..."
          cd $WORKSPACE
          case "{plugin}" in
              "spark"*)
                  export VERSION="{spark_version}"
                  export OPTS="-s {spark_version}"
                  ;;
              "vanilla"*)
                  export VERSION="{hadoop_version}"
                  export OPTS="-v {hadoop_version}"
                  ;;
              *)
                  echo -e "plugin name error"
                  exit 2
                  ;;
          esac
          tox -e venv -- sahara-image-create -p "{plugin}" -i "{cloud_user}" $OPTS
          echo "Creating OpenStack image..."
          IMAGE_ID=$(openstack image create -f value -c id --disk-format qcow2 --container-format bare --file "{build_name}".qcow2 --property architecture="{architecture}" --property os_distro="{os_distro}" --property os_version="{os_version}" --property nectar_build=$BUILD_NUMBER --property nectar_name="{image_name}" "NeCTAR {image_name}")
          echo "Image $IMAGE_ID created!"
          openstack image show $IMAGE_ID
          SAHARA_REG_STATUS=$(openstack dataprocessing image register $IMAGE_ID --username "{cloud_user}" -f value -c Status)
          echo "Sahara image is registered with status: $SAHARA_REG_STATUS !"
          SAHARA_TAG_STATUS=$(openstack dataprocessing image tags add $IMAGE_ID --tags "{plugin}" $VERSION -f value -c Status)
          echo "Sahara image is tagged with status: $SAHARA_TAG_STATUS !"
          rm -f "{build_name}".qcow2
          rm -rf "{build_name}".d
          echo "================================================================================"
          echo ""
          echo "  NeCTAR {image_name} v$BUILD_NUMBER build successful!"
          echo ""
          echo "================================================================================"
