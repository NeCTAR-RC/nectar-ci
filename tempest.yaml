- job:
    name: tempest-compute-host-check
    project-type: freestyle
    defaults: global
    node: tempest
    concurrent: true
    scm:
      - git:
         url: ssh://review.rc.nectar.org.au:29418/internal/nectar-testing.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
    builders:
      - shell: |
          . /opt/tempest/bin/activate
          tmpdir=`mktemp -d --suffix=_tempest`
          cd $tmpdir
          tempest init -c $WORKSPACE/tempest/check_compute_host/$CLOUD
          $WORKSPACE/tempest/setup_tempest.py --host $HOST -s $AVAILABILITY_ZONE .
          export PYTHONWARNINGS="ignore"
          ostestr --serial -w etc/whitelist.yaml
          rm -rf $tmpdir
    parameters:
      - choice:
          name: 'CLOUD'
          choices:
            - prod
            - test
            - dev
          description: "Cloud to run tempest on (Production, Test, Dev). Leave as Production if unsure."
      - string:
          name: 'AVAILABILITY_ZONE'
          description: 'Nova availability zone. <a href="https://wiki.rc.nectar.org.au/wiki/Tempest#AVAILABILITY_ZONES">List of Availability Zones</a>'
      - string:
          name: 'HOST'
          description: |
                Nova host to test. <br>
                - Host must be in AVAILABILITY_ZONE; if not nova will return a 'No Valid Host' error.<br>
                - Leave blank to let scheduler choose a host.
    properties:
      - slack:
          notify-start: true
          notify-success: true
          notify-aborted: true
          notify-notbuilt: true
          notify-unstable: true
          notify-failure: true
          notify-backtonormal: true
          notify-repeatedfailure: true
      - authorization:
          'nobody':
            - job-read
            - job-discover

- job:
    name: tempest-cinder-check
    project-type: freestyle
    defaults: global
    node: tempest
    concurrent: true
    scm:
      - git:
         url: ssh://review.rc.nectar.org.au:29418/internal/nectar-testing.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14
    builders:
      - shell: |
          . /opt/tempest/bin/activate
          tmpdir=`mktemp -d --suffix=_tempest`
          cd $tmpdir
          tempest init -c $WORKSPACE/tempest/check_cinder/$CLOUD
          $WORKSPACE/tempest/setup_tempest.py -s $AVAILABILITY_ZONE .
          export PYTHONWARNINGS="ignore"
          ostestr --serial -w etc/whitelist.yaml
          rm -rf $tmpdir
    parameters:
      - choice:
          name: 'CLOUD'
          choices:
            - prod
            - test
            - dev
          description: "Cloud to run tempest on (Production, Test, Dev). Leave as Production if unsure."
      - string:
          name: 'AVAILABILITY_ZONE'
          description: 'Cinder availability zone. <a href="https://wiki.rc.nectar.org.au/wiki/Tempest#AVAILABILITY_ZONES">List of Availability Zones</a>'
    properties:
      - slack:
          notify-start: true
          notify-success: true
          notify-aborted: true
          notify-notbuilt: true
          notify-unstable: true
          notify-failure: true
          notify-backtonormal: true
          notify-repeatedfailure: true
      - authorization:
          'nobody':
            - job-read
            - job-discover

- project:
    name: tempest-nagios
    site:
        - intersect-01
        - intersect-02
        - melbourne-np
        - melbourne-qh2
        - monash-01
        - monash-02
        - nci
        - pawsey
        - qld
        - sa
        - tasmania
    test:
        - compute
    jobs:
      - 'tempest-nagios-{site}-{test}'

- job-template:
    name: 'tempest-nagios-{site}-{test}'
    project-type: freestyle
    defaults: global
    node: tempest
    concurrent: true

    scm:
      - git:
         url: ssh://review.rc.nectar.org.au:29418/internal/nectar-testing.git
         credentials-id: 4946c3a5-9f5e-4eac-9ec4-90e1e348db14

    builders:
      - shell: '$WORKSPACE/nagios/tempest_nagios.py -c $WORKSPACE/nagios/tempest_nagios.conf -s {site} -t {test}'

    triggers:
      - timed: 'H */30 * * *'

    publishers:
      - slack

    properties:
      - authorization:
          'anonymous':
            - job-read
            - job-discover
      - slack:
          notify-start: true
          notify-success: true
          notify-aborted: true
          notify-notbuilt: true
          notify-unstable: true
          notify-failure: true
          notify-backtonormal: true
          notify-repeatedfailure: true
